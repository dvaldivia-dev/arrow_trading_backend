import pool from "../config/db.js";
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";
import dayjs from "dayjs";
import dotenv from "dotenv";

dotenv.config();

const adminPhoto =
  "PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhLS0gVXBsb2FkZWQgdG86IFNWRyBSZXBvLCB3d3cuc3ZncmVwby5jb20sIEdlbmVyYXRvcjogU1ZHIFJlcG8gTWl4ZXIgVG9vbHMgLS0+Cjxzdmcgd2lkdGg9IjgwMHB4IiBoZWlnaHQ9IjgwMHB4IiB2aWV3Qm94PSIwIDAgMTI4IDEyOCIgZGF0YS1uYW1lPSJMYXllciAxIiBpZD0iTGF5ZXJfMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2E3YWVjZTt9LmNscy0xMiwuY2xzLTIsLmNscy02LC5jbHMtOXtmaWxsOiNmZmZmZmY7fS5jbHMtMntvcGFjaXR5OjAuMzt9LmNscy0ze2ZpbGw6IzhmNTY1Mzt9LmNscy00e2ZpbGw6IzRiYzE5MDt9LmNscy01e2ZpbGw6I2Y4ZGMyNTt9LmNscy01LC5jbHMtNntvcGFjaXR5OjAuNTt9LmNscy03e2ZpbGw6IzUxNTU3MDt9LmNscy04e2ZpbGw6IzM5M2M1NDt9LmNscy0xMHtmaWxsOm5vbmU7c3Ryb2tlOiM1MTU1NzA7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS13aWR0aDoycHg7fS5jbHMtMTAsLmNscy0xMntvcGFjaXR5OjAuMjt9LmNscy0xMXtmaWxsOiNmODU1NjU7fTwvc3R5bGU+PC9kZWZzPjx0aXRsZS8+PGNpcmNsZSBjbGFzcz0iY2xzLTEiIGN4PSI2NCIgY3k9IjY0IiByPSI2MCIvPjxjaXJjbGUgY2xhc3M9ImNscy0yIiBjeD0iNjQiIGN5PSI2NCIgcj0iNDgiLz48cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik0xMTAuMDgsODAuNWwtLjg4LTIuNjljLTIuODktNy44My0xNy4zLTQ2LjkxLTE3Ljc4LTQ4bC0uNS0xLjI5SDkwLjhhMzAsMzAsMCwwLDAtNTMuNiwwaC0uMTNsLS41MiwxLjM2QzM1LjUxLDMyLjQ0LDE5LjA3LDc3LjEsMTksNzcuNDJhNDcuNDksNDcuNDksMCwwLDAtMS41NCwyNC4zOSw2MCw2MCwwLDAsMCw5My4xNiwwLDQ5LjY2LDQ5LjY2LDAsMCwwLS41LTIxLjMxWiIvPjxwYXRoIGNsYXNzPSJjbHMtNCIgZD0iTTIzLjQ1LDEwOC4yMWE2MCw2MCwwLDAsMCw4MS4xLDAsNDMuMzgsNDMuMzgsMCwwLDAsLjg0LTI5LjA5bC0uMTQtLjQ2Yy00Ljg3LTEzLjItMTYuOTEtNDUuODEtMTcuNDktNDcuMjJsLS4wNS0uMWEyNiwyNiwwLDAsMC00Ny40MiwwbDAsLjA4Yy0uNTcsMS4zOC0xNi44Miw0NS4yOC0xNy41LDQ3LjI2YTQzLjQsNDMuNCwwLDAsMCwuNywyOS41MloiLz48cGF0aCBjbGFzcz0iY2xzLTUiIGQ9Ik05OS41Nyw4MC41OUM5My4yMyw2My40LDgzLDM1LjgxLDgyLjIzLDMzLjc4YTIwLDIwLDAsMCwwLTM2LjQ2LDBDNDQuNjMsMzYuNzIsMjkuMSw3OC42NywyOC40NCw4MC41OWEzNy40MiwzNy40MiwwLDAsMCw3LDM2LjIsNjAuMDUsNjAuMDUsMCwwLDAsNTcuMDYsMEEzNy40MSwzNy40MSwwLDAsMCw5OS42Niw4MC45WiIvPjxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTk5LjU3LDgwLjU5QzkzLjIzLDYzLjQsODMsMzUuODEsODIuMjMsMzMuNzhhMjAsMjAsMCwwLDAtMzYuNDYsMEM0NC42MywzNi43MiwyOS4xLDc4LjY3LDI4LjQ0LDgwLjU5YTM3LjQyLDM3LjQyLDAsMCwwLDcsMzYuMiw2MC4wNSw2MC4wNSwwLDAsMCw1Ny4wNiwwQTM3LjQxLDM3LjQxLDAsMCwwLDk5LjY2LDgwLjlaIi8+PHBhdGggY2xhc3M9ImNscy02IiBkPSJNNjQsMTIyQTI5LjQ5LDI5LjQ5LDAsMCwxLDM2LDgzLjEzYy42Ny0xLjkzLDE1LjUtNDIsMTcuMTEtNDYuMjRhMTIsMTIsMCwwLDEsMjEuNzIsMGMxLjA3LDIuNzksOS40LDI1LjMyLDE3LjEzLDQ2LjI2bDAsLjEyQTI5LjQ5LDI5LjQ5LDAsMCwxLDY0LDEyMloiLz48Y2lyY2xlIGNsYXNzPSJjbHMtNyIgY3g9IjY0IiBjeT0iOTIuNSIgcj0iMjAuNSIvPjxjaXJjbGUgY2xhc3M9ImNscy04IiBjeD0iNjQiIGN5PSI5Mi41IiByPSIxMSIvPjxjaXJjbGUgY2xhc3M9ImNscy05IiBjeD0iNzkuNjYiIGN5PSI1Ni41IiByPSI3LjQ5Ii8+PHBhdGggY2xhc3M9ImNscy0xMCIgZD0iTTQ4LjM0LDY4YTExLjQ2LDExLjQ2LDAsMCwxLTkuMS00LjQ4Ii8+PHBhdGggY2xhc3M9ImNscy0xMCIgZD0iTTc5Ljg0LDY4YTExLjUyLDExLjUyLDAsMCwwLDkuODUtNS41NiIvPjxjaXJjbGUgY2xhc3M9ImNscy05IiBjeD0iNDguMzQiIGN5PSI1Ni41IiByPSI3LjQ5Ii8+PHBhdGggY2xhc3M9ImNscy0xMSIgZD0iTTY0LDExM0EyMC40OSwyMC40OSwwLDAsMCw4NC4xMyw5Ni4zLDIyLjMsMjIuMywwLDAsMCw3Miw5My4xN2MtLjU0LDAtMS4wOCwwLTEuNjMuMTFBMi4wNywyLjA3LDAsMCwwLDY4LjYzLDk1YTEuMiwxLjIsMCwwLDEtMS44MS42N0EzLjEyLDMuMTIsMCwwLDAsNjMuODcsOTVhMjIuNTgsMjIuNTgsMCwwLDAtMTIuNDksMTMuNjZBMjAuMzYsMjAuMzYsMCwwLDAsNjQsMTEzWiIvPjxjaXJjbGUgY2xhc3M9ImNscy04IiBjeD0iNzkuNjYiIGN5PSI1Ni41IiByPSI0LjA5Ii8+PGNpcmNsZSBjbGFzcz0iY2xzLTgiIGN4PSI0OC4zNCIgY3k9IjU2LjUiIHI9IjQuMDkiLz48cGF0aCBjbGFzcz0iY2xzLTEyIiBkPSJNNjguMjksOTUuNWExLjE2LDEuMTYsMCwwLDEtMS40Ny4xMyw0Ljg3LDQuODcsMCwwLDAtLjU5LS4zNmMuNDMsMy41NiwxLjY2LDkuMjQsNS4yMSwxMy4wOGExLDEsMCwwLDAsLjczLjMyLDEsMSwwLDAsMCwuNjgtLjI3LDEsMSwwLDAsMCwuMDYtMS40MUM2OS45MSwxMDMuNzUsNjguNzQsOTguODEsNjguMjksOTUuNVoiLz48cGF0aCBjbGFzcz0iY2xzLTQiIGQ9Ik02MS42OCw1OS41MSw2MCw2NC4yOEEyLDIsMCwwLDAsNjEuOTMsNjdoNC4xOWEyLDIsMCwwLDAsMS45My0yLjcybC0xLjY3LTQuNzdBMi40OSwyLjQ5LDAsMCwwLDYxLjY4LDU5LjUxWiIvPjxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTYxLjY4LDU5LjUxLDYwLDY0LjI4QTIsMiwwLDAsMCw2MS45Myw2N2g0LjE5YTIsMiwwLDAsMCwxLjkzLTIuNzJsLTEuNjctNC43N0EyLjQ5LDIuNDksMCwwLDAsNjEuNjgsNTkuNTFaIi8+PC9zdmc+";
const userPhoto =
  "PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhLS0gVXBsb2FkZWQgdG86IFNWRyBSZXBvLCB3d3cuc3ZncmVwby5jb20sIEdlbmVyYXRvcjogU1ZHIFJlcG8gTWl4ZXIgVG9vbHMgLS0+Cjxzdmcgd2lkdGg9IjgwMHB4IiBoZWlnaHQ9IjgwMHB4IiB2aWV3Qm94PSIwIDAgMTI4IDEyOCIgZGF0YS1uYW1lPSJMYXllciAxIiBpZD0iTGF5ZXJfMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6IzAwYWRmZTt9LmNscy0yLC5jbHMtM3tmaWxsOiNmZmZmZmY7fS5jbHMtMntvcGFjaXR5OjAuMzt9LmNscy0xMCwuY2xzLTR7ZmlsbDojMzkzYzU0O30uY2xzLTR7b3BhY2l0eTowLjE7fS5jbHMtNXtmaWxsOiNmODU1NjU7fS5jbHMtNntmaWxsOiNmOGRjMjU7fS5jbHMtN3tmaWxsOiM0YmMxOTA7fS5jbHMtOHtmaWxsOiMzNTZjYjY7fS5jbHMtOXtmaWxsOm5vbmU7c3Ryb2tlOiM1MTU1NzA7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS13aWR0aDoycHg7fTwvc3R5bGU+PC9kZWZzPjx0aXRsZS8+PGNpcmNsZSBjbGFzcz0iY2xzLTEiIGN4PSI2NCIgY3k9IjY0IiByPSI2MCIvPjxjaXJjbGUgY2xhc3M9ImNscy0yIiBjeD0iNjQiIGN5PSI2NCIgcj0iNDgiLz48cGF0aCBjbGFzcz0iY2xzLTMiIGQ9Ik0xMDkuMzksNjguNzZBMTcuNTYsMTcuNTYsMCwwLDAsOTEuODIsNTEuMmExOC4xLDE4LjEsMCwwLDAtMy44NS40MywyNi4xOSwyNi4xOSwwLDAsMC00MC0xMEExNi4zMywxNi4zMywwLDAsMCwyNC44Miw1OWE4Ljc4LDguNzgsMCwwLDAtMy4zNywxNS43NSwyMSwyMSwwLDAsMCwyNC44NiwyOC4wOSwxMS4zNywxMS4zNywwLDAsMCwxOS4yMSwzLjhBMjEsMjEsMCwwLDAsOTkuMTMsODkuODEsMjEuMjcsMjEuMjcsMCwwLDAsOTguNTYsODUsMTcuNTYsMTcuNTYsMCwwLDAsMTA5LjM5LDY4Ljc2WiIvPjxwYXRoIGNsYXNzPSJjbHMtNCIgZD0iTTEwOS4zOSw2OC43NkExNy41NiwxNy41NiwwLDAsMCw5MS44Miw1MS4yYTE4LjEsMTguMSwwLDAsMC0zLjg1LjQzLDI2LjE5LDI2LjE5LDAsMCwwLTQwLTEwQTE2LjMzLDE2LjMzLDAsMCwwLDI0LjgyLDU5YTguNzgsOC43OCwwLDAsMC0zLjM3LDE1Ljc1LDIxLDIxLDAsMCwwLDI0Ljg2LDI4LjA5LDExLjM3LDExLjM3LDAsMCwwLDE5LjIxLDMuOEEyMSwyMSwwLDAsMCw5OS4xMyw4OS44MSwyMS4yNywyMS4yNywwLDAsMCw5OC41Niw4NSwxNy41NiwxNy41NiwwLDAsMCwxMDkuMzksNjguNzZaIi8+PHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMTA2LjUzLDYwLjQ5Yy0uMDctLjQ4LS4xOC0xLjA5LS4zMi0xLjc4QTE3LjUxLDE3LjUxLDAsMCwwLDkxLjgyLDUxLjJhMTguMSwxOC4xLDAsMCwwLTMuODUuNDMsMjYuMTksMjYuMTksMCwwLDAtNDAtMTBBMTYuMzMsMTYuMzMsMCwwLDAsMjQuODIsNTlhOC44LDguOCwwLDAsMC02LjQ3LDUuNUE5Ljg4LDkuODgsMCwwLDAsMjkuNDEsNzEsMTcuODksMTcuODksMCwwLDAsNTkuMDgsODguMTlhMTcuNzcsMTcuNzcsMCwwLDAsMzIuNzMtOS42LDE4LDE4LDAsMCwwLS4zNS0zLjQ3LDEyLjkzLDEyLjkzLDAsMCwwLDE1LjA3LTE0LjYzWiIvPjxwYXRoIGNsYXNzPSJjbHMtNSIgZD0iTTk3LjIyLDE0QTU5LjY0LDU5LjY0LDAsMCwwLDgxLjE0LDYuNSw3Mi45Myw3Mi45MywwLDAsMCw0My42OSw1OC4xOEw1Ni43Niw2MC41QTU5LjcyLDU5LjcyLDAsMCwxLDk3LjIyLDE0WiIvPjxwYXRoIGNsYXNzPSJjbHMtNiIgZD0iTTk3LjIzLDE0LjA1QTYwLDYwLDAsMCwwLDU2Ljc2LDYwLjVsMTMuMDgsMi4zMmE0Ni41Myw0Ni41MywwLDAsMSwzOS42MS0zOEE2MCw2MCwwLDAsMCw5Ny4yMywxNC4wNVoiLz48cGF0aCBjbGFzcz0iY2xzLTciIGQ9Ik0xMTgsMzcuODNhNjAsNjAsMCwwLDAtOC41NS0xMyw0Ni40Miw0Ni40MiwwLDAsMC0zOS42MSwzOGwxMy4wOCwyLjMyYTMzLjEzLDMzLjEzLDAsMCwxLDMyLjYzLTI3LjQxQzExNi4zNiwzNy43MywxMTcuMTgsMzcuNzcsMTE4LDM3LjgzWiIvPjxwYXRoIGNsYXNzPSJjbHMtNCIgZD0iTTgyLjkyLDY1LjE0YTMzLjE0LDMzLjE0LDAsMCwxLDQuNjMtMTJBMTMsMTMsMCwwLDAsNzEsNTQuMTFhMTYuNDksMTYuNDksMCwwLDAtMTAuMjEtMy41NmgtLjMzYTEyLjk0LDEyLjk0LDAsMCwwLTgtOC43NEExMi42MywxMi42MywwLDAsMCw0OSw0MWE3My40LDczLjQsMCwwLDAtNS4yNiwxNy4xNEw1Ni43Niw2MC41aDBsMTMuMDgsMi4zMmgwWiIvPjxwYXRoIGNsYXNzPSJjbHMtOCIgZD0iTTcwLDEyMy43YTU5Ljg2LDU5Ljg2LDAsMCwwLDEwLTEuODdWNzZINzBaIi8+PHBhdGggY2xhc3M9ImNscy04IiBkPSJNNDAsMTE5YTU5LjYyLDU5LjYyLDAsMCwwLDEwLDMuMzVWNzZINDBaIi8+PHBhdGggY2xhc3M9ImNscy0zIiBkPSJNODMsNTUuMjFBOSw5LDAsMCwwLDcxLjQsNjAuNWgwYTEyLjQyLDEyLjQyLDAsMCwwLTE0LjU1LTUuM0E5LDksMCwxLDAsNDksNjNhMTIuNDQsMTIuNDQsMCwwLDAsMjMuNDIsOC40MUExMi43LDEyLjcsMCwwLDAsNzMsNjkuNDksOSw5LDAsMSwwLDgzLDU1LjIxWiIvPjxwYXRoIGNsYXNzPSJjbHMtOSIgZD0iTTY2LDcyYTQsNCwwLDAsMCw0LDRIODAiLz48cGF0aCBjbGFzcz0iY2xzLTkiIGQ9Ik01My42Nyw3MmE0LDQsMCwwLDEtNCw0SDQwIi8+PHBhdGggY2xhc3M9ImNscy0xMCIgZD0iTTUyLjQ1LDk0YTEsMSwwLDAsMS0uOTQtMS4wNiw4LjU2LDguNTYsMCwwLDEsMTcsMEExLDEsMCwwLDEsNjcuNTUsOTRaIi8+PHBhdGggY2xhc3M9ImNscy01IiBkPSJNNjUuNzUsOTRhNi4wNiw2LjA2LDAsMCwwLTExLjUsMFoiLz48cGF0aCBjbGFzcz0iY2xzLTgiIGQ9Ik0zNiwxMTBhMiwyLDAsMCwxLTQsMGMwLTEuMS45LTMuNDEsMi0zLjQxUzM2LDEwOC45LDM2LDExMFoiLz48cGF0aCBjbGFzcz0iY2xzLTgiIGQ9Ik01OC42NywxMTlhMiwyLDAsMCwxLTQsMGMwLTEuMS44OS0zLjQxLDItMy40MVM1OC42NywxMTcuOSw1OC42NywxMTlaIi8+PHBhdGggY2xhc3M9ImNscy04IiBkPSJNNjYsMTE1LjQxYTIsMiwwLDAsMS00LDBjMC0xLjEuOS0zLjQxLDItMy40MVM2NiwxMTQuMzEsNjYsMTE1LjQxWiIvPjxwYXRoIGNsYXNzPSJjbHMtOCIgZD0iTTg3LjU1LDExNS40MWEyLDIsMCwwLDEtNCwwYzAtMS4xLjktMy40MSwyLTMuNDFTODcuNTUsMTE0LjMxLDg3LjU1LDExNS40MVoiLz48L3N2Zz4=";

export const register = async (req, res) => {
  const { username, password, type } = req.body;

  const hashedPassword = await bcrypt.hash(password, 10);
  try {
    const [rows] = await pool.query(
      "INSERT INTO syusers (Username, Password, Full_Name, Status, Type, Photo) VALUES (?, ?,  ?, ?, ?, ?)",
      [
        username,
        hashedPassword,
        username,
        1,
        type,
        type === "admin" ? adminPhoto : userPhoto,
      ]
    );
    res.json({ message: "Usuario registrado", userId: rows.insertId });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

export const login = async (req, res) => {
  const { username, password } = req.body;
  try {
    const [rows] = await pool.query(
      "SELECT * FROM syusers WHERE Username = ?",
      [username]
    );
    if (rows.length === 0)
      return res.status(404).json({ message: "Usuario no encontrado" });

    const user = rows[0];
    const validPassword = await bcrypt.compare(password, user.Password);
    if (!validPassword)
      return res.status(401).json({ message: "Credenciales inv√°lidas" });

    const token = jwt.sign(
      { id: user.id, username: user.username },
      process.env.JWT_SECRET,
      { expiresIn: "8h" }
    );
    // console.log(user);
    res.json({
      token,
      expiresAt: dayjs().add(8, "hour").toISOString(),
      fullName: user.Full_Name,
      type: user.Type,
      status: user.Status,
      photo: user.Photo,
      username: user.Username,
    });
  } catch (err) {
    res.status(500).json({ error: err.message + err });
  }
};
